---
- name: Copy over the nginx configuration file for the website
  include_tasks: webconfig.yml
  tags: hypothesis-web

- name: Run the hypothesis initialization script
  command: "{{ openstax_hypothesis_role.virtualenv_bin_dir }}/python -m h init"
  environment:
      APP_URL: "{{ openstax_hypothesis_role.server_name }}"
  args: 
    chdir: "{{ openstax_hypothesis_role.application_dir }}"
  tags: hypothesis-init

- name: copy over the alembic config
  become: yes
  template:
    src: conf/alembic.ini
    dest: "{{ openstax_hypothesis_role.application_dir }}/conf/alembic.ini"
  tags: alembic-config

- name: copy over the application .service and .socket file
  become: yes
  template:
    src: "{{ item.template }}"
    dest: "{{ item.dest }}"
  with_items: 
    - "{{ openstax_hypothesis_role.services }}"
  when: item.state|default('present') != 'absent'

- name: copy over the box private_key
  become: yes
  copy:
    content: "{{ openstax_hypothesis_role.box_rsa_private_key_content }}"
    dest: "{{ openstax_hypothesis_role.box_rsa_private_key_path }}"
    force: yes

- name: start the h-worker process
  become: yes
  service:
    name: h-worker
    state: started
  tags: start-worker

- name: start the h-beat process
  become: yes
  service:
    name: h-beat
    state: started
  tags: start-beat
